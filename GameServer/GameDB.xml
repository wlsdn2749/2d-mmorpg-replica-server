<?xml version="1.0" encoding="utf-8"?>
<GameDB>
  <!-- ====== 계정 관련 DB ======-->
  <Table name="Accounts">
    <Column name="userId" type="int" notnull="true"/>
    <Column name="createdAt" type="datetime" notnull="true" default="SYSUTCDATETIME()"/>
    <Column name="lastLoginAt" type="datetime" notnull="true"/>
  
    <Index type="clustered">
      <PrimaryKey/>
      <Column name="userId"/>
    </Index>
  </Table>
  <Procedure name="spAccountsUpsert">
    <Param name="@userId" type="int"/>
    <Body>
      <![CDATA[
       SET NOCOUNT ON;
       SET XACT_ABORT ON;
       
       DECLARE @now DATETIME = SYSUTCDATETIME();
       
       UPDATE dbo.Accounts
       SET LastLoginAt = @now
       WHERE [userId] = @userId;
       
       IF @@ROWCOUNT = 0
       BEGIN
           INSERT INTO [dbo].[Accounts] ([userId], [createdAt], [lastLoginAt])
           VALUES (@userId, @now, @now);
       END
      ]]>
    </Body>
  </Procedure>
  <!--===== 캐릭터 관련 DB =====-->
  <Table name="Characters">
    <Column name="characterId" type="int" notnull="true" identity="1,1"/>
    <Column name="userId" type="int" notnull="true"/>
    <Column name="username" type="nvarchar(32)" notnull="true"/>
    <Column name="gender" type="int" notnull="true"/>
    <Column name="region" type="int" notnull="true"/>
    <Column name="level" type="int" notnull="true" default="1"/>
    <Column name="exp" type="int" notnull="true" default="0"/>
    <Column name="hp" type="int" notnull="true" default="100"/>
    <Column name="maxHp" type="int" notnull="true" default="100"/>
    <Column name="atk" type="int" notnull="true" default="10"/>
    <Column name="def" type="int" notnull="true" default="5"/>
    <Column name="lastRoom" type="int" notnull="true"/>
    <Column name="posX" type="int" notnull="true" default="0"/>
    <Column name="posY" type="int" notnull="true" default="0"/>
    <Column name="dir" type="int" notnull="true" default="0"/>
    <Column name="createdAt" type="datetime" notnull="true" default="SYSUTCDATETIME()"/>
    <Index type="clustered">
      <PrimaryKey/>
      <Column name="characterId"/>
    </Index>
    <ForeignKey name="FK_Characters_userId_Accounts_userId"
            refTable="Accounts"
            onDelete="NO_ACTION"
            onUpdate="NO_ACTION">
      <Column local="userId" ref="userId"/>
    </ForeignKey>
  </Table>
  <Procedure name="spCreateCharacter">
    <Param name="@userId" type="int"/>
    <Param name="@username" type="nvarchar(32)"/>
    <Param name="@gender" type="int"/>
    <Param name="@region" type="int"/>
    <Param name="@lastRoom" type="int"/>
    <Body>
      <![CDATA[
       SET NOCOUNT ON;
       SET XACT_ABORT ON;
       
       INSERT INTO [dbo].[Characters] ([userId], [username], [gender], [region], [lastRoom])
       VALUES (@userId, @username, @gender, @region, @lastRoom);       
      ]]>
    </Body>
  </Procedure>
  <Procedure name="spCharacterUsernameExists">
    <Param name="@username" type="nvarchar(32)"/>
    <Param name="@exists" type="int" dir="out"/>
    <Body>
      <![CDATA[
       SET NOCOUNT ON;
       SELECT @Exists =
        CASE WHEN EXISTS (
            SELECT 1
            FROM [dbo].[Characters] WITH (READCOMMITTED)
            WHERE username = @username
        )
        THEN 1 ELSE 0 END;
      ]]>
    </Body>
  </Procedure>
  <Procedure name="spGetCharactersByUser">
    <Param name="@userId" type="int"/>
    <Body>
      <![CDATA[
        SET NOCOUNT ON;

        SELECT
            characterId, username, posX, posY, gender, region, dir, level
        FROM [dbo].[Characters]
        WHERE [userId] = @userId
        ORDER BY [level] DESC;
      ]]>
    </Body>
  </Procedure>
  <Procedure name="spUpdateCharacterStats">
    <Param name="@characterId" type="int"/>
    <Param name="@posX" type="int"/>
    <Param name="@posY" type="int"/>
    <Param name="@dir" type="int"/>
    <Param name="@lastRoom" type="int"/>
    <Param name="@hp" type="int"/>
    <Param name="@level" type="int"/>
    <Param name="@exp" type="int"/>
    <Body>
      <![CDATA[
      SET NOCOUNT ON;
      SET XACT_ABORT ON;
      
      UPDATE [dbo].[Characters]
      SET 
          posX = @posX,
          posY = @posY,
          dir = @dir,
          lastRoom = @lastRoom,
          hp = @hp,
          level = @level,
          exp = @exp
      WHERE characterId = @characterId;
    ]]>
    </Body>
  </Procedure>
  
  
  <!-- 아래 Procedures는 예시임 -->
  <Table name="Gold">
    <Column name="id" type="int" notnull="true" identity="1,1"/>
    <Column name="gold" type="int" notnull="false"/>
    <Column name="name" type="nvarchar(50)" notnull="false"/>
    <Column name="createDate" type="datetime" notnull="false"/>
    <Index type="clustered"> 
      <PrimaryKey/>
      <Column name="id"/>
    </Index>
  </Table>
  <Procedure name="spInsertGold">
    <Param name="@gold" type="int"/>
    <Param name="@name" type="nvarchar(50)"/>
    <Param name="@createDate" type="datetime"/>
    <Body>
      <![CDATA[
       INSERT INTO [dbo].[Gold] ([gold], [name], [createDate]) VALUES(@gold, @name, @createDate)
      ]]>
    </Body>
  </Procedure>
  <Procedure name="spGetGold">
    <Param name="@gold" type="int"/>
    <Body>
      <![CDATA[
       SELECT id, gold, name, createDate FROM [dbo].[Gold] where gold = (@gold)
      ]]>
    </Body>
  </Procedure>
</GameDB>
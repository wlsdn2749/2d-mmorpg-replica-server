<?xml version="1.0" encoding="utf-8"?>
<GameDB>
  <!-- ====== 계정 관련 DB ======-->
  <Table name="Accounts">
    <Column name="userId" type="int" notnull="true"/>
    <Column name="createdAt" type="datetime" notnull="true" default="SYSUTCDATETIME()"/>
    <Column name="lastLoginAt" type="datetime" notnull="true"/>
  
    <Index type="clustered">
      <PrimaryKey/>
      <Column name="userId"/>
    </Index>
  </Table>
  <Procedure name="spAccountsUpsert">
    <Param name="@userId" type="int"/>
    <Body>
      <![CDATA[
       SET NOCOUNT ON;
       SET XACT_ABORT ON;
       
       DECLARE @now DATETIME = SYSUTCDATETIME();
       
       UPDATE dbo.Accounts
       SET LastLoginAt = @now
       WHERE [userId] = @userId;
       
       IF @@ROWCOUNT = 0
       BEGIN
           INSERT INTO [dbo].[Accounts] ([userId], [createdAt], [lastLoginAt])
           VALUES (@userId, @now, @now);
       END
      ]]>
    </Body>
  </Procedure>
  <!--===== 캐릭터 관련 DB =====-->
  <Table name="Characters">
    <Column name="characterId" type="int" notnull="true" identity="1,1"/>
    <Column name="userId" type="int" notnull="true"/>
    <Column name="username" type="nvarchar(32)" notnull="true"/>
    <Column name="gender" type="int" notnull="true"/>
    <Column name="region" type="int" notnull="true"/>
    <Column name="level" type="int" notnull="true" default="1"/>
    <Column name="exp" type="int" notnull="true" default="0"/>
    <Column name="lastZone" type="int" notnull="true"/>
    <Column name="posX" type="int" notnull="true" default="0"/>
    <Column name="posY" type="int" notnull="true" default="0"/>
    <Column name="createdAt" type="datetime" notnull="true" default="SYSUTCDATETIME()"/>
    <Index type="clustered">
      <PrimaryKey/>
      <Column name="characterId"/>
    </Index>
    <ForeignKey name="FK_Characters_userId_Accounts_userId"
            refTable="Accounts"
            onDelete="NO_ACTION"
            onUpdate="NO_ACTION">
      <Column local="userId" ref="userId"/>
    </ForeignKey>
  </Table>
  
  
  <!-- 아래 Procedures는 예시임 -->
  <Table name="Gold">
    <Column name="id" type="int" notnull="true" identity="1,1"/>
    <Column name="gold" type="int" notnull="false"/>
    <Column name="name" type="nvarchar(50)" notnull="false"/>
    <Column name="createDate" type="datetime" notnull="false"/>
    <Index type="clustered"> 
      <PrimaryKey/>
      <Column name="id"/>
    </Index>
  </Table>
  <Procedure name="spInsertGold">
    <Param name="@gold" type="int"/>
    <Param name="@name" type="nvarchar(50)"/>
    <Param name="@createDate" type="datetime"/>
    <Body>
      <![CDATA[
       INSERT INTO [dbo].[Gold] ([gold], [name], [createDate]) VALUES(@gold, @name, @createDate)
      ]]>
    </Body>
  </Procedure>
  <Procedure name="spGetGold">
    <Param name="@gold" type="int"/>
    <Body>
      <![CDATA[
       SELECT id, gold, name, createDate FROM [dbo].[Gold] where gold = (@gold)
      ]]>
    </Body>
  </Procedure>
</GameDB>